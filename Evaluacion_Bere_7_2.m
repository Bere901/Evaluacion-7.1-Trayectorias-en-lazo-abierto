%% EXAMPLE: Differential drive vehicle following waypoints using the 
% Pure Pursuit algorithm
%
% Copyright 2018-2019 The MathWorks, Inc.

%% Define Vehicle
R = 0.1;                % Wheel radius [m]
L = 0.5;                % Wheelbase [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.1;               % Sample time [s]
tVec = 0:sampleTime:300;         % Time array

initPose = [0;0;pi];             % Initial pose (x y theta)
pose = zeros(3,numel(tVec));    % Pose matrix
pose(:,1) = initPose;

% Define waypoints
waypoints = [0,0.1883363067009; 
             0.2152761013071,0.2927725374847; 
             0.4705646654453,0.3623966913406; 
             0.6794371270129,0.4436248708391; 
             0.8302894603673,0.5480611016229; 
             1.0391619219349,0.6408933067641; 
             1.1435981527187,0.9890140760435; 
             1.196849797099,1.3546293493198
             1.1435981527187,0.9890140760435; 
             1.2364303578599,0.675705383692; 
             1.3060545117157,0.4088127939112; 
             1.4104907424996,0.2231483836289; 
             1.5381350245687,0.0606920246318; 
             1.7354034604936,0.0142759220612; 
             2,0; 2.2343765631274,0.0142759220612; 
             2.4548530503377,0.0142759220612; 
             2.4548530503377,0.0142759220612; 
             2.6521214862626,0.0142759220612; 
             3,0; 3.197510691467,0.3623966913406; 
             3.4295912043199,0.7569335631906; 
             3.4527992556052,1.1050543324699; 
             3.6036515889596,0.872973819617; 
             3.6732757428154,0.71051746062; 
             3.8937522300257,0.675705383692; 
             3.9981884608095,0.5248530503377; 
             4.2302689736624,0.4552288964818; 
             4.4623494865153,0.3275846144127; 
             4.6,0; 
             4.4623494865153,0.327584614412; 
             4.2302689736624,0.4552288964818; 
             3.9981884608095,0.5248530503377; 
             3.8937522300257,0.675705383692; 
             3.4063831530346,1.3139267940376; 
             3.2207187427523,1.1514704350405; 
             3,1; 
             2.8206020995115,0.906279832982; 
             2.554015900608,0.8093393970171; 
             2.3116648106957,0.8093393970171; 
             2.0693137207833,0.8699271694951; 
             1.7542573038973,0.9911027144513; 
             1.4270833325157,1.1607484773899; 
             1.196849797099,1.3546293493198; 
             1.0635566976472,1.5121575577628; 
             0.9544987071867,1.7666262021707; 
             0.8333231622305,1.9362719651094; 
             0.7363827262656,2.105917728048; 
             0.6030896268138,2.4088565904384; 
             0.5182667453445,2.6512076803507; 
             0.469796527362,2.893558770263; 
             0.4819140818576,3.148027414671;
             0.6394422903006,3.0026167607236; 
             0.627324735805,2.7481481163156; 
             0.6515598447962,2.5179145808989; 
             0.7363827262656,2.263445936491; 
             0.6515598447962,2.5179145808989; 
             0.627324735805,2.7481481163156; 
             0.6394422903006,3.0026167607236;
             0.7969704987436,3.3176731776096; 
             1.0877918066384,3.5479067130263; 
             1.4149657780201,3.6811998124781; 
             1.6573168679324,3.7054349214693; 
             1.826962630871,3.5721418220175; 
             1.6088466499499,3.4994364950438;
             1.3664955600376,3.463083831557;
             1.0877918066384,3.5479067130263;
             0.7969704987436,3.3176731776096;
             0.5667369633269,3.5357891585307;
             0.6394422903006,3.0026167607236;
             0.5667369633269,3.5357891585307;
             0.7969704987436,3.8508455754167;
             1.0635566976472,4.1780195467983;
             1.4270833325157,4.250724873772;
             1.7542573038973,4.2870775372589;
             1.4270833325157,4.250724873772;;
             1.0635566976472,4.1780195467983;
             0.7969704987436,3.8508455754167;
             0.5667369633269,3.5357891585307;
             0.5909720723182,3.778140248443;
             0.7000300627787,4.190137101294;
             0.7969704987436,4.5900163996493;
             1,5;
             1.3422604510464,5.2564818969082;
             1.7542573038973,5.4624803233336;
             2.1299014932614,5.5230680958117;
             2.4449579101474,5.5230680958117;
             2.8811898719896,5.5230680958117;
             3.0871882984151,5.3655398873687;
             3.3780096063099,5.2080116789257;
             3.5234202602573,4.9898956980046;
             3.6445958052134,4.7717797170835;
             3.7657713501696,4.50519351818;
             3.8384766771433,4.2870775372589;
             4,4;
             3.6809484687003,4.0204913383553;
             3.499185151266,4.2628424282677;
             3.1114234074063,4.3719004187282;
             2.711544109051,4.3597828642326;
             3.1114234074063,4.3719004187282;
             3.499185151266,4.2628424282677;
             3.6809484687003,4.0204913383553;
             4,4;
             4.0081224400819,3.7417875849562;
             3.9960048855863,3.5600242675219;
             3.753653795674,3.5600242675219;
             3.4870675967704,3.6084944855044;
             3.2083638433713,3.7902578029386;
             2.8448372085028,3.8023753574342;
             2.6994265545554,3.6811998124781;

             2.4934281281299,3.5600242675219;
             2.4328403556518,3.3297907321052;
             2.6146036730861,3.1964976326534;
             2.7600143270335,3.0268518697148;
             2.7721318815291,2.7845007798025;
             2.5297807916167,2.6875603438376;
             2.1056663842702,2.6633252348463;
             1.8390801853666,2.6633252348463;
             1.8027275218798,2.9177938792543;
             1.8148450763754,3.0995571966885;
             1.9966083938096,3.2086151871491;
             2.0450786117921,3.4509662770614;
             1.9966083938096,3.2086151871491;
             1.8148450763754,3.0995571966885;
             1.8027275218798,2.9177938792543;
             1.8390801853666,2.6633252348463;
             2.1056663842702,2.6633252348463;
             2.5297807916167,2.6875603438376;
             2.7721318815291,2.7845007798025;
             2.7600143270335,3.0268518697148;
             2.6146036730861,3.1964976326534;
             2.4328403556518,3.3297907321052;
             2.4934281281299,3.5600242675219;
             2.9054249809808,3.5842593765132;
             3.1962462888756,3.5842593765132;
             3.4870675967704,3.6084944855044;
             3.753653795674,3.5600242675219;
             3.9960048855863,3.5600242675219;
             4.0323575490731,3.3419082866008;

             4.0323575490731,3.148027414671;
             4.3352964114636,3.4024960590789;
             4.3352964114636,3.1237923056797;
             4.3352964114636,2.8572061067762;
             4.2868261934811,2.6390901258551;
             4.1050628760468,2.4088565904384;
             3.9717697765951,2.2028581640129;
             4.1050628760468,2.4088565904384;
             4.2868261934811,2.6390901258551;
             4.3352964114636,2.8572061067762;
             4.3352964114636,3.1237923056797;
             4.3352964114636,3.4024960590789;
             4.0323575490731,3.148027414671;
             3.9960048855863,2.7117954528288;
             3.8021240136564,2.0574475100655;
             3.7900064591608,1.8756841926313;
             3.7294186866827,1.6818033207014;
             3.3537744973186,1.85144908364;
             3,2;
             2.7600143270335,2.2028581640129;
             2.4570754646431,2.4330916994296;
             2.2874297017044,2.3361512634647;
             2.1299014932614,2.4330916994296;
             1.9481381758272,2.2755634909866;
             1.7784924128886,2.1301528370392;
             1.669434422428,1.9241544106137;
             1.8875504033491,1.85144908364;
             2.1783717112439,1.9241544106137;
             2.4570754646431,1.9726246285962;
             3,2;
             3.7294186866827,1.6818033207014;
             3.4063831530346,1.3139267940376;
             3.4527992556052,1.1050543324699;
             3.6036515889596,0.872973819617;
             3.6732757428154,0.71051746062;
             3.8937522300257,0.675705383692;
             3.9981884608095,0.5248530503377;
             4.2302689736624,0.4552288964818;
             4.4623494865153,0.3275846144127;
             4.7109406008276,0.3731074351749;
             4.7109406008276,1.3667469038154;
             4.7109406008276,2.0574475100655;
             4.7109406008276,2.7723832253069;
             4.6867054918364,3.4267311680701;
             4.5776475013759,3.935668456886;
             4.4322368474285,4.3113126462501;
             4.1898857575162,4.7596621625879;
             4,5;
             3.656713359709,5.1958941244301;
             3.4143622697967,5.4988329868205;
             3.0750707439195,5.6927138587504;
             2.6630738910685,5.8987122851758;
             2.3358999196869,5.8865947306802;
             2.081431275279,5.8260069582021;
             1.6330817589412,5.8260069582021;
             1.3180253420551,5.6805963042547;
             1.0877918066384,5.4745978778293;
             0.8575582712217,5.1595414609432;
             0.627324735805,4.6748392811186;
             0.4940316363532,4.3719004187282;
             0.4213263093795,3.9114333478948;
             0.3365034279102,3.3419082866008;
             0.2395629919453,2.9177938792543;
             0.2274454374497,2.4936794719077;
             0.1668576649716,2.0695650645611;
             0.1668576649716,1.6818033207014;
             0.1789752194672,1.4273346762935;
             0.1183874469891,1.1607484773899;
             0,1;
             0, 0.6760462975653;
             0, 0.2882845537056;
              ]

% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = 0.15;
controller.DesiredLinearVelocity = 0.25;
controller.MaxAngularVelocity = 18.5;

%% Simulation loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec) 
    % Run the Pure Pursuit controller and convert output to wheel speeds
    [vRef,wRef] = controller(pose(:,idx-1));
    [wL,wR] = inverseKinematics(dd,vRef,wRef);
    
    % Compute the velocities
    [v,w] = forwardKinematics(dd,wL,wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB,pose(:,idx-1));  % Convert from body to world
    
    % Perform forward discrete integration step
    pose(:,idx) = pose(:,idx-1) + vel*sampleTime; 
    
    % Update visualization
    viz(pose(:,idx),waypoints)
    waitfor(r);
end